<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="ELF文件解析" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="ELF(Executable and Linkable Format)" /><meta property="og:description" content="ELF(Executable and Linkable Format)" /><link rel="canonical" href="https://fengf3ng.github.io/posts/ELF%E6%96%87%E4%BB%B6%E8%A7%A3%E6%9E%90/" /><meta property="og:url" content="https://fengf3ng.github.io/posts/ELF%E6%96%87%E4%BB%B6%E8%A7%A3%E6%9E%90/" /><meta property="og:site_name" content="fengF3ng’s Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-08-15T13:57:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="ELF文件解析" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-08-15T13:57:00+08:00","datePublished":"2022-08-15T13:57:00+08:00","description":"ELF(Executable and Linkable Format)","headline":"ELF文件解析","mainEntityOfPage":{"@type":"WebPage","@id":"https://fengf3ng.github.io/posts/ELF%E6%96%87%E4%BB%B6%E8%A7%A3%E6%9E%90/"},"url":"https://fengf3ng.github.io/posts/ELF%E6%96%87%E4%BB%B6%E8%A7%A3%E6%9E%90/"}</script><title>ELF文件解析 | fengF3ng's Blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="fengF3ng's Blog"><meta name="application-name" content="fengF3ng's Blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/sidebar/nanachi.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">fengF3ng's Blog</a></div><div class="site-subtitle font-italic">专注个人笔记</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>首页</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>分类</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/fengF3ng" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['hefeng.hf','foxmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> 首页 </a> </span> <span>ELF文件解析</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> 文章</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="搜索..."> </span> <span id="search-cancel" >取消</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>ELF文件解析</h1><div class="post-meta text-muted"> <span> 发表于 <em class="" data-ts="1660543020" data-df="YYYY-MM-DD" data-toggle="tooltip" data-placement="bottom"> 2022-08-15 </em> </span><div class="d-flex justify-content-between"> <span> 作者 <em> <a href="https://github.com/fengF3ng">fengF3ng</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="4771 字"> <em>26 分钟</em>阅读</span></div></div></div><div class="post-content"><h1 id="elfexecutable-and-linkable-format">ELF(Executable and Linkable Format)</h1><blockquote><p>格式定义: /usr/include/elf.h</p></blockquote><blockquote><p>内核中相关处理代码: fs/binfmt_elf.c</p></blockquote><p>本文针对ELF 32-bit进行讲解</p><ul><li>Linux下常用的可执行文件、可重定位文件、共享库和核心转储(core dump)的标准文件格式<li>其他平台可执行文件格式：PE、Mach-O、COFF、COM<li>对象文件/目标文件(obejctive file)<li>loader只加载可执行文件</ul><dl><dt>可执行的对象文件(ET_EXEC)<dd>可直接运行的程序，必须包含Segment。<dt>可重定位的对象文件(ET_REL, *.o, *.a)<dd>需要与其它对象文件链接成可执行文件或共享文件，必须包含Section，静态链接库也属于此类。用ar工具可将众多.o归档为.a静态库文件。<dt>可被共享的对象文件(ET_DYN, *.so)<dd>与其他对象文件/可执行文件链接，必须同时包含Segment和Section<dt>核心转储文件(ET_CORE, core dump)<dd>进程意外中止时保存相关信息</dl><p>《CTF all in one》中编译的三种文件分别属于relocatable、shared object和executable</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="gp">$</span><span class="w"> </span>file elfDemo.o
<span class="go">elfDemo.o: ELF 32-bit LSB relocatable, Intel 80386, version 1 (SYSV), not stripped
</span><span class="gp">$</span><span class="w"> </span>file elfDemo.out
<span class="go">elfDemo.out: ELF 32-bit LSB shared object, Intel 80386, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux.so.2, BuildID[sha1]=449104f371131705d7828a5886ff8760bda78d68, for GNU/Linux 3.2.0, not stripped
</span><span class="gp">$</span><span class="w"> </span>file elfDemo_static.out
<span class="go">elfDemo_static.out: ELF 32-bit LSB executable, Intel 80386, version 1 (GNU/Linux), statically linked, BuildID[sha1]=fc554e5541196a56bc66f48dc1d2dcf247faaffe, for GNU/Linux 3.2.0, not stripped
</span></pre></table></code></div></div><h1 id="结构框架">结构框架</h1><p><img data-src="/assets/img/2022-08/2022-08-15-ELF%E6%96%87%E4%BB%B6%E8%A7%A3%E6%9E%90/ELF整体结构.drawio.svg" alt="Window shadow" class="shadow" data-proofer-ignore> <em>ELF整体结构</em></p><p>ELF文件由ELF header、Program header table、Section header table和众多节组成，当我们在进行链接的时候以Section为单位进行组织，而执行的时候以Segment为单位进行组织。</p><p><img data-src="/assets/img/2022-08/2022-08-15-ELF%E6%96%87%E4%BB%B6%E8%A7%A3%E6%9E%90/ELF关系示意.drawio.svg" alt="Window shadow" class="shadow" data-proofer-ignore> <em>ELF关系示意</em></p><p>通过ELF header可以检索Program header table和Section header</p><p>本节主要介绍Section和Segment的概念。</p><p>Segment</p><ul><li>告诉内核，执行ELF文件时应该如何映射内存<li>每个Segment主要包含加载地址、文件中的范围、内存权限、对齐方式等信息<li>运行时必须提供的信息</ul><p>Section</p><ul><li>section直接对应汇编代码的一段<li>告诉链接器，ELF中每个部分是什么，代码、只读数据、重定位信息等的位置<li>每个Section主要包含Section类型，文件中的位置、大小等信息<li>链接器依赖Section信息将不同的对象文件的代码、数据信息合并，并修复互相引用</ul><p>需要注意的是Program header table在链接时是可以省略的，并不是必须的。同理，Section header table在执行时也是这样。</p><p>两者的关系</p><ul><li>系统会将相同权限的Section会放入同一个Segment，例如.text和.rodata section。<li>系统内存的权限管理的粒度是以页为单位，页内的内存是具有同样的权限等属性，并且操作系统对内存的管理往往追求高效和高利用率，将多个section合并在一起减少内部碎片<li>一个Segment包含许多Section，一个Section可以属于多个Segment</ul><dl><dt>程序分段的好处<dd>进程运行过程中，代码指令根据流程依次执行，只需访问一次(当然跳转和递归可能使代码执行多次)；而数据(数据段和BSS段)通常需要访问多次，因此单独开辟空间以方便访问和节约空间。具体解释如下： 当程序被装载后，数据和指令分别映射到两个虚存区域。数据区对于进程而言可读写，而指令区对于进程只读。两区的权限可分别设置为可读写和只读。以防止程序指令被有意或无意地改写。现代CPU具有极为强大的缓存(Cache)体系，程序必须尽量提高缓存命中率。指令区和数据区的分离有利于提高程序的局部性。现代CPU一般数据缓存和指令缓存分离，故程序的指令和数据分开存放有利于提高CPU缓存命中率。当系统中运行多个该程序的副本时，其指令相同，故内存中只须保存一份该程序的指令部分。若系统中运行数百进程，通过共享指令将节省大量空间(尤其对于有动态链接的系统)。其他只读数据如程序里的图标、图片、文本等资源也可共享。而每个副本进程的数据区域不同，它们是进程私有的。此外，临时数据及需要再次使用的代码在运行时放入栈区中，生命周期短。全局数据和静态数据可能在整个程序执行过程中都需要访问，因此单独存储管理。堆区由用户自由分配，以便管理。</dl><h1 id="elf-header">ELF Header</h1><p>位于文件开始处，用来描述文件的组织。</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="k">typedef</span> <span class="k">struct</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">e_ident</span><span class="p">[</span><span class="n">EI_NIDENT</span><span class="p">];</span>	<span class="cm">/* Magic number and other info */</span>
  <span class="n">Elf32_Half</span>	<span class="n">e_type</span><span class="p">;</span>			<span class="cm">/* Object file type */</span>
  <span class="n">Elf32_Half</span>	<span class="n">e_machine</span><span class="p">;</span>		<span class="cm">/* Architecture */</span>
  <span class="n">Elf32_Word</span>	<span class="n">e_version</span><span class="p">;</span>		<span class="cm">/* Object file version */</span>
  <span class="n">Elf32_Addr</span>	<span class="n">e_entry</span><span class="p">;</span>		<span class="cm">/* Entry point virtual address */</span>
  <span class="n">Elf32_Off</span>	<span class="n">e_phoff</span><span class="p">;</span>		<span class="cm">/* Program header table file offset */</span>
  <span class="n">Elf32_Off</span>	<span class="n">e_shoff</span><span class="p">;</span>		<span class="cm">/* Section header table file offset */</span>
  <span class="n">Elf32_Word</span>	<span class="n">e_flags</span><span class="p">;</span>		<span class="cm">/* Processor-specific flags */</span>
  <span class="n">Elf32_Half</span>	<span class="n">e_ehsize</span><span class="p">;</span>		<span class="cm">/* ELF header size in bytes */</span>
  <span class="n">Elf32_Half</span>	<span class="n">e_phentsize</span><span class="p">;</span>		<span class="cm">/* Program header table entry size */</span>
  <span class="n">Elf32_Half</span>	<span class="n">e_phnum</span><span class="p">;</span>		<span class="cm">/* Program header table entry count */</span>
  <span class="n">Elf32_Half</span>	<span class="n">e_shentsize</span><span class="p">;</span>		<span class="cm">/* Section header table entry size */</span>
  <span class="n">Elf32_Half</span>	<span class="n">e_shnum</span><span class="p">;</span>		<span class="cm">/* Section header table entry count */</span>
  <span class="n">Elf32_Half</span>	<span class="n">e_shstrndx</span><span class="p">;</span>		<span class="cm">/* Section header string table index */</span>
<span class="p">}</span> <span class="n">Elf32_Ehdr</span><span class="p">;</span>
</pre></table></code></div></div><p>其中一些比较重要的信息是ELF文件的位数、ABI版本信息以及机器信息。</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="gp">$</span><span class="w"> </span>readelf <span class="nt">-h</span> elfDemo.out
<span class="go">ELF Header:
  Magic:   7f 45 4c 46 01 01 01 00 00 00 00 00 00 00 00 00
  Class:                             ELF32
  Data:                              2's complement, little endian
  Version:                           1 (current)
  OS/ABI:                            UNIX - System V
  ABI Version:                       0
  Type:                              DYN (Shared object file)
  Machine:                           Intel 80386
  Version:                           0x1
  Entry point address:               0x1090
  Start of program headers:          52 (bytes into file)
  Start of section headers:          14536 (bytes into file)
  Flags:                             0x0
  Size of this header:               52 (bytes)
  Size of program headers:           32 (bytes)
  Number of program headers:         12
  Size of section headers:           40 (bytes)
  Number of section headers:         31
  Section header string table index: 30
</span></pre></table></code></div></div><h1 id="program-header-table">Program Header Table</h1><ul><li>告诉系统如何创建进程映像<li>程序头部仅对于可执行文件和共享目标文件有意义，可重定位文件不需要<li>可执行文件或者共享目标文件的程序头部是一个结构数组，每个结构描述了一个段 或者系统准备程序执行所必需的其它信息。</ul><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="cm">/* Program Header */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">Elf32_Word</span>	<span class="n">p_type</span><span class="p">;</span>		<span class="cm">/* segment type */</span>
	<span class="n">Elf32_Off</span>	<span class="n">p_offset</span><span class="p">;</span>	<span class="cm">/* segment offset */</span>
	<span class="n">Elf32_Addr</span>	<span class="n">p_vaddr</span><span class="p">;</span>	<span class="cm">/* virtual address of segment */</span>
	<span class="n">Elf32_Addr</span>	<span class="n">p_paddr</span><span class="p">;</span>	<span class="cm">/* physical address - ignored? */</span>
	<span class="n">Elf32_Word</span>	<span class="n">p_filesz</span><span class="p">;</span>	<span class="cm">/* number of bytes in file for seg. */</span>
	<span class="n">Elf32_Word</span>	<span class="n">p_memsz</span><span class="p">;</span>	<span class="cm">/* number of bytes in mem. for seg. */</span>
	<span class="n">Elf32_Word</span>	<span class="n">p_flags</span><span class="p">;</span>	<span class="cm">/* flags */</span>
	<span class="n">Elf32_Word</span>	<span class="n">p_align</span><span class="p">;</span>	<span class="cm">/* memory alignment */</span>
<span class="p">}</span> <span class="n">Elf32_Phdr</span><span class="p">;</span>
</pre></table></code></div></div><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre><td class="rouge-code"><pre><span class="gp">$</span><span class="w"> </span>readelf <span class="nt">-l</span> elfDemo.out
<span class="go">
Elf file type is DYN (Shared object file)
Entry point 0x1090
There are 12 program headers, starting at offset 52

Program Headers:
  Type           Offset   VirtAddr   PhysAddr   FileSiz MemSiz  Flg Align
  PHDR           0x000034 0x00000034 0x00000034 0x00180 0x00180 R   0x4
  INTERP         0x0001b4 0x000001b4 0x000001b4 0x00013 0x00013 R   0x1
      [Requesting program interpreter: /lib/ld-linux.so.2]
  LOAD           0x000000 0x00000000 0x00000000 0x003f8 0x003f8 R   0x1000
  LOAD           0x001000 0x00001000 0x00001000 0x002f4 0x002f4 R E 0x1000
  LOAD           0x002000 0x00002000 0x00002000 0x001bc 0x001bc R   0x1000
  LOAD           0x002ed8 0x00003ed8 0x00003ed8 0x00138 0x00144 RW  0x1000
  DYNAMIC        0x002ee0 0x00003ee0 0x00003ee0 0x000f8 0x000f8 RW  0x4
  NOTE           0x0001c8 0x000001c8 0x000001c8 0x00060 0x00060 R   0x4
  GNU_PROPERTY   0x0001ec 0x000001ec 0x000001ec 0x0001c 0x0001c R   0x4
  GNU_EH_FRAME   0x00200c 0x0000200c 0x0000200c 0x0005c 0x0005c R   0x4
  GNU_STACK      0x000000 0x00000000 0x00000000 0x00000 0x00000 RW  0x10
  GNU_RELRO      0x002ed8 0x00003ed8 0x00003ed8 0x00128 0x00128 R   0x1

 Section to Segment mapping:
  Segment Sections...
   00
   01     .interp
   02     .interp .note.gnu.build-id .note.gnu.property .note.ABI-tag .gnu.hash .dynsym .dynstr .gnu.version .gnu.version_r .rel.dyn .rel.plt
   03     .init .plt .plt.got .plt.sec .text .fini
   04     .rodata .eh_frame_hdr .eh_frame
   05     .init_array .fini_array .dynamic .got .data .bss
   06     .dynamic
   07     .note.gnu.build-id .note.gnu.property .note.ABI-tag
   08     .note.gnu.property
   09     .eh_frame_hdr
   10
   11     .init_array .fini_array .dynamic .got
</span></pre></table></code></div></div><h1 id="section-header-table">Section Header Table</h1><ul><li>包含了描述文件节区的信息<li>用于链接的目标文件必须包含节区头部表<li>目标文件中的每个节区都有对应的节区头部描述它，反过来，有节区头部不意 味着有节区。<li>每个节区占用文件中一个连续字节区域(这个区域可能长度为 0)。<li>文件中的节区不能重叠，不允许一个字节存在于两个节区中的情况发生。<li>目标文件中可能包含非活动空间(INACTIVE SPACE)。这些区域不属于任何头部和节区，其内容指定。<li>以“.”开头的节区名称是系统保留的。应用程序可以使用没有前缀的节区名称，以避 免与系统节区冲突。<li>目标文件格式允许人们定义不在上述列表中的节区。<li>目标文件中也可以包含多个名字相同的节区。<li>保留给处理器体系结构的节区名称一般构成为:处理器体系结构名称简写 + 节区名称。<li>处理器名称应该与 e_machine 中使用的名称相同。例如 .FOO.psect 街区是由FOO 体系结构定义的 psect 节区。</ul><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="k">typedef</span> <span class="k">struct</span>
<span class="p">{</span>
  <span class="n">Elf32_Word</span>	<span class="n">sh_name</span><span class="p">;</span>		<span class="cm">/* Section name (string tbl index) */</span>
  <span class="n">Elf32_Word</span>	<span class="n">sh_type</span><span class="p">;</span>		<span class="cm">/* Section type */</span>
  <span class="n">Elf32_Word</span>	<span class="n">sh_flags</span><span class="p">;</span>		<span class="cm">/* Section flags */</span>
  <span class="n">Elf32_Addr</span>	<span class="n">sh_addr</span><span class="p">;</span>		<span class="cm">/* Section virtual addr at execution */</span>
  <span class="n">Elf32_Off</span>	<span class="n">sh_offset</span><span class="p">;</span>		<span class="cm">/* Section file offset */</span>
  <span class="n">Elf32_Word</span>	<span class="n">sh_size</span><span class="p">;</span>		<span class="cm">/* Section size in bytes */</span>
  <span class="n">Elf32_Word</span>	<span class="n">sh_link</span><span class="p">;</span>		<span class="cm">/* Link to another section */</span>
  <span class="n">Elf32_Word</span>	<span class="n">sh_info</span><span class="p">;</span>		<span class="cm">/* Additional section information */</span>
  <span class="n">Elf32_Word</span>	<span class="n">sh_addralign</span><span class="p">;</span>		<span class="cm">/* Section alignment */</span>
  <span class="n">Elf32_Word</span>	<span class="n">sh_entsize</span><span class="p">;</span>		<span class="cm">/* Entry size if section holds table */</span>
<span class="p">}</span> <span class="n">Elf32_Shdr</span><span class="p">;</span>
</pre></table></code></div></div><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre><td class="rouge-code"><pre><span class="gp">$</span><span class="w"> </span>readelf <span class="nt">-S</span> elfDemo.out
<span class="go">There are 31 section headers, starting at offset 0x38c8:

Section Headers:
  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al
  [ 0]                   NULL            00000000 000000 000000 00      0   0  0
  [ 1] .interp           PROGBITS        000001b4 0001b4 000013 00   A  0   0  1
  [ 2] .note.gnu.build-i NOTE            000001c8 0001c8 000024 00   A  0   0  4
  [ 3] .note.gnu.propert NOTE            000001ec 0001ec 00001c 00   A  0   0  4
  [ 4] .note.ABI-tag     NOTE            00000208 000208 000020 00   A  0   0  4
  [ 5] .gnu.hash         GNU_HASH        00000228 000228 000020 04   A  6   0  4
  [ 6] .dynsym           DYNSYM          00000248 000248 000080 10   A  7   1  4
  [ 7] .dynstr           STRTAB          000002c8 0002c8 00009d 00   A  0   0  1
  [ 8] .gnu.version      VERSYM          00000366 000366 000010 02   A  6   0  2
  [ 9] .gnu.version_r    VERNEED         00000378 000378 000030 00   A  7   1  4
  [10] .rel.dyn          REL             000003a8 0003a8 000040 08   A  6   0  4
  [11] .rel.plt          REL             000003e8 0003e8 000010 08  AI  6  24  4
  [12] .init             PROGBITS        00001000 001000 000024 00  AX  0   0  4
  [13] .plt              PROGBITS        00001030 001030 000030 04  AX  0   0 16
  [14] .plt.got          PROGBITS        00001060 001060 000010 10  AX  0   0 16
  [15] .plt.sec          PROGBITS        00001070 001070 000020 10  AX  0   0 16
  [16] .text             PROGBITS        00001090 001090 000249 00  AX  0   0 16
  [17] .fini             PROGBITS        000012dc 0012dc 000018 00  AX  0   0  4
  [18] .rodata           PROGBITS        00002000 002000 00000c 00   A  0   0  4
  [19] .eh_frame_hdr     PROGBITS        0000200c 00200c 00005c 00   A  0   0  4
  [20] .eh_frame         PROGBITS        00002068 002068 000154 00   A  0   0  4
  [21] .init_array       INIT_ARRAY      00003ed8 002ed8 000004 04  WA  0   0  4
  [22] .fini_array       FINI_ARRAY      00003edc 002edc 000004 04  WA  0   0  4
  [23] .dynamic          DYNAMIC         00003ee0 002ee0 0000f8 08  WA  7   0  4
  [24] .got              PROGBITS        00003fd8 002fd8 000028 04  WA  0   0  4
  [25] .data             PROGBITS        00004000 003000 000010 00  WA  0   0  4
  [26] .bss              NOBITS          00004010 003010 00000c 00  WA  0   0  4
  [27] .comment          PROGBITS        00000000 003010 00002b 01  MS  0   0  1
  [28] .symtab           SYMTAB          00000000 00303c 0004b0 10     29  48  4
  [29] .strtab           STRTAB          00000000 0034ec 0002c1 00      0   0  1
  [30] .shstrtab         STRTAB          00000000 0037ad 000118 00      0   0  1
Key to Flags:
  W (write), A (alloc), X (execute), M (merge), S (strings), I (info),
  L (link order), O (extra OS processing required), G (group), T (TLS),
  C (compressed), x (unknown), o (OS specific), E (exclude),
  p (processor specific)
</span></pre></table></code></div></div><p>索引为零（SHN_UNDEF）的节区头部是存在的，尽管此索引标记的是未定义的节区应用，详见《CTF all in one》</p><h1 id="section">Section</h1><h2 id="dynsym"><span class="mr-2">dynsym</span><a href="#dynsym" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li>.dynsym节区包含了动态链接符号表<li>Elf32_Sym保存外部函数索引值<li>外部函数的索引值为ELF32_R_SYM(r_info)<li>Elf32_Sym[num]中的num对应着ELF32_R_SYM(Elf32_Rel-&gt;r_info)<li>ELF23_R_SYM(Elf32_Rel-&gt;r_info) = (Elf32_Rel-&gt;r_info)»8<li>ELF32_R_TYPE(r_info)对应R_386_JUMP_SLOT</ul><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="cp">#define ELF32_R_SYM(val)       ((val)&gt;&gt;8)
#define ELF32_R_TYPE(val)      ((val)&amp;0xff)
#define ELF32_R_INFO(sym,type) (((sym)&lt;&lt;8)+((type)&amp;0xff))
#define ELF64_R_SYM(i)         ((i)&gt;&gt;32)
#define ELF64_R_TYPE(i)        ((i)&amp;0xffffffff)
#define ELF64_R_INFO(sym,type) ((((Elf64_Xword)(sym))&lt;&lt;32)+(type))
</span>
<span class="k">struct</span> <span class="n">Elf32_Sym</span><span class="p">{</span>
  <span class="n">Elf32_Word</span> <span class="n">st_name</span><span class="p">;</span> <span class="cm">/*index into the symbol string table*/</span>
  <span class="n">Elf32_Addr</span> <span class="n">st_value</span><span class="p">;</span>
  <span class="n">Elf32_Word</span> <span class="n">st_size</span><span class="p">;</span> <span class="cm">/*size of the symbol. 0 for no size or unkown size*/</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">st_info</span><span class="p">;</span> <span class="cm">/*BIND&lt;&lt;4+TYPE&amp;0x0f*/</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">st_other</span><span class="p">;</span> <span class="cm">/*0 for reserve*/</span>
  <span class="n">Elf32_Half</span> <span class="n">st_shndx</span><span class="p">;</span> <span class="cm">/*relevant section table index, some indicates special meanings*/</span>
<span class="p">};</span>
</pre></table></code></div></div><h2 id="dynstr"><span class="mr-2">dynstr</span><a href="#dynstr" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li>包含了动态链接的字符串<li>.dynstr节以\x00作为开始和结束<li>中间每个字符串以\x00间隔<li>dynstr+Elf32_Sym[ELF32_R_SYM(r_info)]-&gt;st_name为函数名的字符串地址</ul><h2 id="reldyn"><span class="mr-2">rel.dyn</span><a href="#reldyn" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li>.rel.dyn节用于变量重定位</ul><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">Elf32_Rel</span><span class="p">{</span>
  <span class="n">Elf32_Addr</span>  <span class="n">r_offset</span><span class="p">;</span>  <span class="cm">/* Address */</span>
  <span class="n">Elf32_Word</span>  <span class="n">r_info</span><span class="p">;</span>    <span class="cm">/* Relocation type and symbol index */</span>
<span class="p">};</span>
</pre></table></code></div></div><h2 id="relplt"><span class="mr-2">rel.plt</span><a href="#relplt" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li>.rel.plt节用于函数重定位<li>.rel.plt中r_offset表示GOT表项地址，r_info表示符号表索引</ul><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="gp">$</span><span class="w"> </span>readelf <span class="nt">-r</span> elfDemo.out
<span class="go">
Relocation section '.rel.dyn' at offset 0x3a8 contains 8 entries:
 Offset     Info    Type            Sym.Value  Sym. Name
00003ed8  00000008 R_386_RELATIVE
00003edc  00000008 R_386_RELATIVE
00003ff8  00000008 R_386_RELATIVE
00004004  00000008 R_386_RELATIVE
00003fec  00000106 R_386_GLOB_DAT    00000000   _ITM_deregisterTMClone
00003ff0  00000306 R_386_GLOB_DAT    00000000   __cxa_finalize@GLIBC_2.1.3
00003ff4  00000406 R_386_GLOB_DAT    00000000   __gmon_start__
00003ffc  00000606 R_386_GLOB_DAT    00000000   _ITM_registerTMCloneTa

Relocation section '.rel.plt' at offset 0x3e8 contains 2 entries:
 Offset     Info    Type            Sym.Value  Sym. Name
00003fe4  00000207 R_386_JUMP_SLOT   00000000   printf@GLIBC_2.0
00003fe8  00000507 R_386_JUMP_SLOT   00000000   __libc_start_main@GLIBC_2.0
</span></pre></table></code></div></div><h2 id="pltprocedure-linkage-table"><span class="mr-2">plt(procedure linkage table)</span><a href="#pltprocedure-linkage-table" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li>包含了动态链接器调用从共享库导入的函数必须的相关代码<li>过程链接表，将位置独立的函数调用重定位到绝对位置<li>每个外部函数均有一段PLT代码，用于跳转到相应GOT表项中存储的地址</ul><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="go">Disassembly of section .plt:

</span><span class="gp">00000000004003f0 &lt;__libc_start_main@plt-0x10&gt;</span>:
<span class="gp">  4003f0:	ff 35 12 0c 20 00    	pushq  0x200c12(%rip)        #</span><span class="w"> </span>601008 &lt;_GLOBAL_OFFSET_TABLE_+0x8&gt;
<span class="gp">  4003f6:	ff 25 14 0c 20 00    	jmpq   *0x200c14(%rip)        #</span><span class="w"> </span>601010 &lt;_GLOBAL_OFFSET_TABLE_+0x10&gt;
<span class="go">  4003fc:	0f 1f 40 00          	nopl   0x0(%rax)

</span><span class="gp">0000000000400400 &lt;__libc_start_main@plt&gt;</span>:
<span class="gp">  400400:	ff 25 12 0c 20 00    	jmpq   *0x200c12(%rip)        #</span><span class="w"> </span>601018 &lt;_GLOBAL_OFFSET_TABLE_+0x18&gt;
<span class="gp">  400406:	68 00 00 00 00       	pushq  $</span>0x0
<span class="gp">  40040b:	e9 e0 ff ff ff       	jmpq   4003f0 &lt;_init+0x28&gt;</span><span class="w">
</span><span class="go">
</span></pre></table></code></div></div><h2 id="pltgot"><span class="mr-2">plt.got</span><a href="#pltgot" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>调用非延迟绑定的外部符号?</p><h2 id="text"><span class="mr-2">text</span><a href="#text" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>程序代码段</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="gp">.text:00401000 ;</span><span class="w"> </span>Segment <span class="nb">type</span>: Pure code
<span class="gp">.text:00401000 ;</span><span class="w"> </span>Segment permissions: Read/Execute
</pre></table></code></div></div><h2 id="dynamic"><span class="mr-2">dynamic</span><a href="#dynamic" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li>如果一个可执行文件参与动态链接，则程序头部包含类型为PT_DYNAMIC的段，其中包含.dynamic节区<li>为动态链接提供信息，如符号表、字符串表</ul><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="cm">/* Dynamic structure */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">Elf32_Sword</span>	<span class="n">d_tag</span><span class="p">;</span>		<span class="cm">/* controls meaning of d_val */</span>
  <span class="k">union</span> <span class="p">{</span>
    <span class="n">Elf32_Word</span>	<span class="n">d_val</span><span class="p">;</span>	<span class="cm">/* Multiple meanings - see d_tag */</span>
    <span class="n">Elf32_Addr</span>	<span class="n">d_ptr</span><span class="p">;</span>	<span class="cm">/* program virtual address */</span>
  <span class="p">}</span> <span class="n">d_un</span><span class="p">;</span>
<span class="p">}</span> <span class="n">Elf32_Dyn</span><span class="p">;</span>
</pre></table></code></div></div><h3 id="d_tag"><span class="mr-2">d_tag</span><a href="#d_tag" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="table-wrapper"><table><thead><tr><th>常量标识<th>类型<tbody><tr><td>DT_NEEDED<td>保存了所需的共享库名的字符串偏移表<tr><td>DT_SYMTAB<td>动态表的地址，对应的节名.dynsym<tr><td>DT_REL/DT_RELA<td>动态链接重定位表的位置<tr><td>DT_HASH<td>符号散列表的地址，对应的节名.gnu,hash</table></div><h2 id="gotglobal-offset-table"><span class="mr-2">got(global offset table)</span><a href="#gotglobal-offset-table" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li>.got保存全局变量的GOT表<li>如stdin/stdout/stderr，非延迟绑定</ul><h2 id="gotplt"><span class="mr-2">got.plt</span><a href="#gotplt" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li>.got.plt前三项有特殊含义<li>第四项开始保存全局函数的GOT表项<li>GOT表项初始状态指向一段PLT代码，当库函数被首次调用，真正的函数地址会被解析并填入相应的GOT表项</ul><p><img data-src="/assets/img/2022-08/2022-08-15-ELF%E6%96%87%E4%BB%B6%E8%A7%A3%E6%9E%90/gotplt%E7%BB%93%E6%9E%84.drawio.svg" alt="Window shadow" data-proofer-ignore> <em>.got.plt结构</em></p><h2 id="data"><span class="mr-2">data</span><a href="#data" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li>已初始化且初值不为0的全局变量和静态局部变量<li>常量数据（字符串常量）</ul><p>数据段保存在目标文件中(在嵌入式系统里一般固化在镜像文件中)，其内容由程序初始化。</p><p>当程序读取数据段的数据时，系统会出发缺页故障，从而分配相应的物理内存；当程序读取BSS段的数据时，内核会将其转到一个全零页面，不会发生缺页故障，也不会为其分配相应的物理内存。</p><h2 id="bssblock-started-by-symbol"><span class="mr-2">bss(Block Started by Symbol)</span><a href="#bssblock-started-by-symbol" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li>未初始化的全局变量和静态局部变量<li>初始值为0的全局变量和静态局部变量（依赖于编译器实现）<li>未定义且初值不为0的符号</ul><p>由于程序加载时，BSS会被操作系统清零，所以未赋初值或初值为0的全局变量都在BSS中。BSS段仅为未初始化的静态分配变量预留位置，在目标文件中并不占据空间，这样可减少目标文件体积。但程序运行时需为变量分配内存空间，故目标文件必须记录所有未初始化的静态分配变量大小总和(通过start_bss和end_bss地址写入机器代码)。当加载器(loader)加载程序时，将为BSS段分配的内存初始化为0。在嵌入式软件中，进入main()函数之前BSS段被C运行时系统映射到初始化为全零的内存(效率较高)</p><p>尽管均放置于BSS段，但初值为0的全局变量是强符号，而未初始化的全局变量是弱符号。若其他地方已定义同名的强符号(初值可能非0)，则弱符号与之链接时不会引起重定义错误，但运行时的初值可能并非期望值(会被强符号覆盖)。因此，定义全局变量时，若只有本文件使用，则尽量使用static关键字修饰；否则需要为全局变量定义赋初值(哪怕0值)，保证该变量为强符号，以便链接时发现变量名冲突，而不是被未知值覆盖。</p><blockquote><p>某些编译器将未初始化的全局变量保存在common段，链接时再将其放入BSS段。在编译阶段可通过-fno-common选项来禁止将未初始化的全局变量放入common段。</p></blockquote><blockquote><p>运行时数据段和BSS段的整个区段通常称为数据区。某些资料中“数据段”指代数据段 + BSS段 + 堆。</p></blockquote><h2 id="symtab"><span class="mr-2">symtab</span><a href="#symtab" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>该数据结构在新版本的glibc中可能已经合并入Elf64_Sym了。</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">name</span><span class="p">;</span> <span class="cm">/* String table offset*/</span>
  <span class="kt">char</span> <span class="n">type</span><span class="o">:</span><span class="mi">4</span><span class="p">,</span> <span class="cm">/* Function or data (4 bits) */</span>
       <span class="nl">binding:</span><span class="mi">4</span><span class="p">;</span> <span class="cm">/* Local or global (4 bits) */</span>
  <span class="kt">char</span> <span class="n">reserved</span><span class="p">;</span> <span class="cm">/* Unused */</span>
  <span class="kt">short</span> <span class="n">section</span><span class="p">;</span> <span class="cm">/* Section header index */</span>
  <span class="kt">long</span> <span class="n">value</span><span class="p">;</span> <span class="cm">/* Section offset or absolute address */</span>
  <span class="kt">long</span> <span class="n">size</span><span class="p">;</span> <span class="cm">/* Object size in bytes */</span>
<span class="p">}</span>
</pre></table></code></div></div><p>section除了正常节的索引，还存在三个伪节。</p><ul><li>ABS: 不该被重定位的符号<li>UNDEF: 未定义符号，需要从其他模块引用<li>COMMON: 未被分配位置的未初始化的数据目标</ul><p>这些伪节仅存在于可重定位目标文件，可执行目标文件中没有。</p><h2 id="扩展section"><span class="mr-2">扩展Section</span><a href="#扩展section" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>有些编译器对如上节区进行了扩展，这些已存在的扩展都使用约定俗成的名</p><ul><li>.sdata<li>.tdesc<li>.sbss<li>.lit4<li>.lit8<li>.reginfo<li>.gptab<li>.liblist<li>.conflict</ul><h1 id="appendix">Appendix</h1><h2 id="宏定义含义"><span class="mr-2">宏定义含义</span><a href="#宏定义含义" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>可参考《程序员自我修养》了解各变量值的含义</p><h2 id="分析工具"><span class="mr-2">分析工具</span><a href="#分析工具" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>常见工具readelf、objdump、file和nm</p><dl><dt>readelf<dd>显示elf文件的信息，提供调试信息。<dt>objdump<dd>显示目标文件信息，提供反汇编功能<dt>file<dd>打印基本信息及ELF头部信息<dt>nm<dd>打印符号信息<dt>hexdump<dd>打印十六进制<dt>strings<dd>打印文件中可打印字符的字符串<code class="language-plaintext highlighter-rouge">strings -a -t x libc_32.so.6 | grep "/bin/sh"</code>获得偏移量</dl><h1 id="reference">Reference</h1><ol><li>《ELF手册》<li>《程序员自我修养》<li>《链接器和加载器》<li><a href="http://gnaixx.cc/2016/09/30/20160930_elf-file/">ELF文件格式分析</a><li><a href="https://firmianay.gitbook.io/ctf-all-in-one/1_basic/1.5_reverse_basic/1.5.3_elf">CTF all in one/Linux ELF</a></ol></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/linux/'>Linux</a>, <a href='/categories/basic/'>Basic</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/elf/" class="post-tag no-text-decoration" >elf</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> 本文由作者按照 <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> 进行授权</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">分享</span> <span class="share-icons"> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="分享链接" data-title-succeed="链接已复制！"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">最近更新</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/%E7%A8%8B%E5%BA%8F%E7%BC%96%E8%AF%91%E4%B8%8E%E9%93%BE%E6%8E%A5/">程序编译与链接</a><li><a href="/posts/%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E6%94%BB%E9%98%B2%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/">高级网络攻防漏洞利用</a><li><a href="/posts/%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E6%94%BB%E9%98%B2%E9%80%86%E5%90%91/">高级网络攻防逆向</a><li><a href="/posts/Linux%E4%BF%9D%E6%8A%A4%E6%9C%BA%E5%88%B6/">Linux保护机制</a><li><a href="/posts/%E5%88%B7%E9%A2%98%E6%80%BB%E7%BB%931/">栈刷题小结</a></ul></div><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/elf/">elf</a> <a class="post-tag" href="/tags/heap/">heap</a> <a class="post-tag" href="/tags/pwnable/">pwnable</a> <a class="post-tag" href="/tags/memory/">memory</a> <a class="post-tag" href="/tags/pwn/">pwn</a> <a class="post-tag" href="/tags/stack/">stack</a> <a class="post-tag" href="/tags/abi/">abi</a> <a class="post-tag" href="/tags/dram/">dram</a> <a class="post-tag" href="/tags/dynelf/">dynelf</a> <a class="post-tag" href="/tags/fmt/">fmt</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">文章内容</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>相关文章</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/%E7%AC%A6%E5%8F%B7%E8%A7%A3%E6%9E%90/"><div class="card-body"> <em class="small" data-ts="1664288100" data-df="YYYY-MM-DD" > 2022-09-27 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>符号解析</h3><div class="text-muted small"><p> 结合源码分析 符号和符号表 在链接器的上下文中，可以定义三种不同的符号 当前模块定义并且能被其他模块引用的全局符号，包括函数和全局变量。 其他模块定义并且被当前模块引用的全局符号，也称为外部符号。 只被当前模块定义和引用的局部符号，包括带static属性的函数和全局变量。 其他变量一般通过栈管理，不生成符号。但是，带static修饰的过程变量却会出现在.symt...</p></div></div></a></div><div class="card"> <a href="/posts/%E7%A8%8B%E5%BA%8F%E7%BC%96%E8%AF%91%E4%B8%8E%E9%93%BE%E6%8E%A5/"><div class="card-body"> <em class="small" data-ts="1660562340" data-df="YYYY-MM-DD" > 2022-08-15 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>程序编译与链接</h3><div class="text-muted small"><p> [] 重新梳理静态链接 三连音(triplet) 即isa-os-libc组成的短语，描述了程序运行需要的基本条件。例如我们最常见的x86_64-linux-gnu三连音。 构建 构建编译器的平台的三连音。 宿主 编译器运行平台的三连音。 目标 编译器编译出来的程序平台的三连音。 基于构建、宿主和目标的关系又可以定义本地编译和交叉编译等概念 编译...</p></div></div></a></div><div class="card"> <a href="/posts/dl_runtime_resolve%E8%A7%A3%E6%9E%90/"><div class="card-body"> <em class="small" data-ts="1663230000" data-df="YYYY-MM-DD" > 2022-09-15 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>dl_runtime_resolve解析</h3><div class="text-muted small"><p> _dl_runtime_resolve 位于loader中，用于解析外部函数符号的函数，解析完成后会直接执行解析的函数。 被PLT[0]调用时需要传入link_map和reloc_arg参数，紧接着将这些参数传入_dl_fixup进行解析。 # glibc/sysdeps/i386/dl-trampoline.S _dl_runtime_resolve: cfi_adjust_cfa...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/RSA%E5%85%A5%E9%97%A8%E5%B0%8F%E7%BB%93/" class="btn btn-outline-primary" prompt="上一篇"><p>RSA入门小结</p></a> <a href="/posts/%E7%A8%8B%E5%BA%8F%E7%BC%96%E8%AF%91%E4%B8%8E%E9%93%BE%E6%8E%A5/" class="btn btn-outline-primary" prompt="下一篇"><p>程序编译与链接</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://github.com/fengF3ng">fengF3ng</a>. <span data-toggle="tooltip" data-placement="top" title="除非另有说明，本网站上的博客文章均由作者按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。">保留部分权利。</span></p></div><div class="footer-right"><p class="mb-0"> 本站由 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 生成，采用 <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> 主题。</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/elf/">elf</a> <a class="post-tag" href="/tags/heap/">heap</a> <a class="post-tag" href="/tags/pwnable/">pwnable</a> <a class="post-tag" href="/tags/memory/">memory</a> <a class="post-tag" href="/tags/pwn/">pwn</a> <a class="post-tag" href="/tags/stack/">stack</a> <a class="post-tag" href="/tags/abi/">abi</a> <a class="post-tag" href="/tags/dram/">dram</a> <a class="post-tag" href="/tags/dynelf/">dynelf</a> <a class="post-tag" href="/tags/fmt/">fmt</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">发现新版本的内容。</p><button type="button" class="btn btn-primary" aria-label="Update"> 更新 </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">搜索结果为空</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/zh.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
