---
title: web服务器
date: 2022-10-11 9:42:00 +0800
categories: [Web, Basic]
tags: [web server]     # TAG names should always be lowercase
---

# 常见web服务器



![Window shadow](/assets/img/2022-10/2022-10-11-web%E6%9C%8D%E5%8A%A1%E5%99%A8/wss-share.png){: .shadow}
_市场份额_

Developer|August 2022|Percent|September 2022|Percent|Change
--|--|--|--|--|--
nginx|328,204,211|28.91%|319,472,149|28.29%|-0.62
Apache|256,787,976|22.62%|247,026,645|21.88%|-0.75
OpenResty|92,609,414|8.16%|92,645,981|8.20%|0.05
Cloudflare|77,538,226|6.83%|83,638,115|7.41%|0.58

# Nginx

Nginx是一款高性能的HTTP和反向代理服务器，能够选择高效的epoll、kqueue、eventport最为网络I/O模型，在高连接并发的情况下，能够支持高达5万个并发连接数的响应，而内存、CPU等系统资源消耗却非常低，运行非常稳定。

I/O密集型

- 正向代理
- 反向代理
- 负载均衡
- 动静分离
- 高可用

## 工作模式

多进程 + 事件驱动的模式

![Window shadow](/assets/img/2022-10/2022-10-11-web%E6%9C%8D%E5%8A%A1%E5%99%A8/nginx.png){: .shadow}
_nginx_

### 主进程

主要功能是和外界通信和对内部其他进程进行管理，具体来说有以下几点：

- 读取Nginx配置文件并验证其有效性和正确性
- 建立、绑定和关闭socket
- 按照配置生成、管理工作进程
- 接收外界指令，比如重启、关闭、重载服务等指令
- 日志文件管理

### 子进程

是由主进程生成，生成数量可以在配置文件中定义。该进程主要工作有：

- 接收客户端请求
- 将请求依次送入各个功能模块进行过滤处理
- IO调用，获取响应数据
- 与后端服务器通信，接收后端服务器处理结果
- 数据缓存，访问缓存索引，查询和调用缓存数据
- 发送请求结果，响应客户端请求
- 接收主进程指令，如重启、重载、退出等

# Apache

Apache的模块支持非常丰富，在速度和性能上不及其他轻量级WEB服务器，是属于重量级产品，所消耗的内存也比其他WEB服务器要高。

计算密集型

功能与nginx类似，额外提供web语言解析等。

## 工作模式

Web服务器Apache目前一共有三种稳定的MPM（Multi-Processing Module，多进程处理模块）模式。 

### prefork mpm

Prefork MPM实现了一个非线程的、预派生的web服务器。它在Apache启动之初，就先预派生一些子进程，然后等待连接；可以减少频繁创建和销毁进程的开销，每个子进程只有一个线程，在一个时间点内，只能处理一个请求。这是一个成熟稳定，可以兼容新老模块，也不需要担心线程安全问题，但是一个进程相对占用资源，消耗大量内存，不擅长处理高并发的场景。 

![Window shadow](/assets/img/2022-10/2022-10-11-web%E6%9C%8D%E5%8A%A1%E5%99%A8/prefork_mpm.jpg){: .shadow}
_prefork_

### worker mpm

和prefork模式相比，worker使用了多进程和多线程的混合模式，worker模式也同样会先预派生一些子进程，然后每个子进程创建一些线程，同时包括一个监听线程，每个请求过来会被分配到一个线程来服务。线程比起进程会更轻量，因为线程是通过共享父进程的内存空间，因此，内存的占用会减少一些，在高并发的场景下会比prefork有更多可用的线程，表现会更优秀一些；另外，如果一个线程出现了问题也会导致同一进程下的线程出现问题，如果是多个线程出现问题，也只是影响Apache的一部分，而不是全部。由于用到多进程多线程，需要考虑到线程的安全了，在使用keep-alive长连接的时候，某个线程会一直被占用，即使中间没有请求，需要等待到超时才会被释放（该问题在prefork模式下也存在）。 

![Window shadow](/assets/img/2022-10/2022-10-11-web%E6%9C%8D%E5%8A%A1%E5%99%A8/worker_mpm.jpg){: .shadow}
_worker_

### event mpm

这是Apache最新的工作模式，它和worker模式很像，不同的是在于它解决了keep-alive长连接的时候占用线程资源被浪费的问题，在event工作模式中，会有一些专门的线程用来管理这些keep-alive类型的线程，当有真实请求过来的时候，将请求传递给服务器的线程，执行完毕后，又允许它释放。这增强了在高并发场景下的请求处理。 

![Window shadow](/assets/img/2022-10/2022-10-11-web%E6%9C%8D%E5%8A%A1%E5%99%A8/event_mpm.jpg){: .shadow}
_event_

# OpenResty

OpenResty®: OpenResty® 是一个基于 Nginx 与 Lua 的高性能 Web 平台，其内部集成了大量精良的 Lua 库、第三方模块以及大多数的依赖项。用于方便地搭建能够处理超高并发、扩展性极高的动态 Web 应用、Web 服务和动态网关。

OpenResty® 通过汇聚各种设计精良的 Nginx 模块（主要由 OpenResty 团队自主开发），从而将 Nginx 有效地变成一个强大的通用 Web 应用平台。这样，Web 开发人员和系统工程师可以使用 Lua 脚本语言调动 Nginx 支持的各种 C 以及 Lua 模块，快速构造出足以胜任 10K 乃至 1000K 以上单机并发连接的高性能 Web 应用系统。

OpenResty® 的目标是让你的Web服务直接跑在 Nginx 服务内部，充分利用 Nginx 的非阻塞 I/O 模型，不仅仅对 HTTP 客户端请求,甚至于对远程后端诸如 MySQL、PostgreSQL、Memcached 以及 Redis 等都进行一致的高性能响应。

## 工作模式

master进程（管理worker进程）去fork多个worker进程，master进程和worker进程两者不同进程，fork只是内存内容拷贝而已。

监听操作端口的时候，通过worker进程监听（用户层），将其锁来争夺连接处理（共享内存 + accept锁）

master进程只是管理worker进程，而不是分配任务节点。当任务节点来了，worker进程负责监听，但多个worker进程都会争夺，为了解决这个情况，会有一个共享内存 +accept锁。多个worker进程基于共享内存联系。每个worker进程使用一个虚拟主机，在这个虚拟主机中会创建一个coroutine协程 

OpenResty的同步非阻塞是基于Lua内建的协程，是应用程序级别的多路复用，运行在用户空间，所以它的资源消耗更少

# Cloudflare

Cloudflare（Cloudflare, Inc.）是一家总部位于旧金山的美国跨国科技企业，以向客户提供基于反向代理的内容分发网络（Content Delivery Network, CDN）及分布式域名解析服务（Distributed Domain Name Server）为主要业务，具有防火墙和DDoS保护功能。 



# reference

1. [September 2022 Web Server Survey](https://news.netcraft.com/archives/2022/09/22/september-2022-web-server-survey.html)
2. [Nginx架构分析](https://blog.51cto.com/jacksoner/2315700)
3. [C++后端程序员必须彻底搞懂Nginx，从原理到实战详解](https://zhuanlan.zhihu.com/p/354598764)
4. [Apache 的三种工作模式（Prefork、Worker、Event）](https://blog.mimvp.com/article/27778.html)
5. [Apache监控与调优(六)MPM模块工作原理](https://zhuanlan.zhihu.com/p/107044268)
6. [简单谈谈apache与nginx](https://www.jianshu.com/p/1cf3a88d25c9)
7. [OpenResty](http://openresty.org/cn/)
8. [OpenResty 的两个基石：NGINX 和 LuaJIT](https://zhuanlan.zhihu.com/p/396803871)
9. [C/C++编程： OpenResty入门](https://blog.csdn.net/zhizhengguan/article/details/121097316)
10. [Openresty框架入门详解](https://blog.csdn.net/weixin_47872288/article/details/127181495)
11. [Cloudflare](https://zh.wikipedia.org/wiki/Cloudflare)
