---
title: Linux文件系统
date: 2022-08-16 17:13:00 +0800
categories: [Linux, Basic]
tags: [vfs, fs]     # TAG names should always be lowercase
---

# 磁盘

## 磁盘组成

1. 圆形的磁盘盘(主要记录数据的部分);
2. 机械手臂，与在机械手臂上的磁盘读取头(可擦写磁盘盘上的数据);
3. 主轴马达，可以转动磁盘盘，让机械手臂的读取头在磁盘盘上读写数据。

## 磁盘盘组成

1. 扇区(Sector)为最小的物理储存单位，每个扇区为512 bytes ;
2. 将扇区组成一个圆，那就是磁柱(Cylinder)，磁柱是分割槽(partition)的最小单位
3. 第一个扇区最重要，里面有:主要开机区(Master boot record,MBR)及分割表(partitiontable)，其中 MBR占有446 bytes，而 partition table则占有64 bytes。

## 磁盘分割、格式化、检验与挂载

1. 对磁盘进行分割，以建立可用的partition ;
2. 对该partition进行格式化(format)，以建立系统可用的 filesystem ;
3. 若想要仔细一点，则可对刚刚建立好的filesystem进行检验﹔
4. 在 Linux系统上，需要建立挂载点（亦即是目录），并将他挂载上来﹔

## 设备文件

- /dev/sd[a-p][1-15]:为SCSI, SATA, USB, Flash随身碟等接口的磁盘文件名;
- /dev/hd[a-d][1-63]:为IDE接口的磁盘文件名;

# 文件系统

- 传统文件系统:ext2 / minix /MS-DOS /FAT(用vfat模块)/iso9660(光盘)等等
- 日志式文件系统:ext3 / ReiserFS / Windows' NTFS /IBM's JFS / SGI's XFS
- 网络文件系统∶NFS / SMBFS

## 日志式文件系统

1. 预备∶当系统要写入一个档案时，会先在日志记录区块中纪录某个档案准备要写入的信息;
2. 实际写入∶开始写入档案的权限与数据;开始更新metadata 的数据;
3. 结束︰完成数据与metadata的更新后，在日志记录区块当中完成该档案的纪录。

## 数据一致性

既然有不一致当然就得要克服!在早期的Ext2文件系统中，如果发生这个问题，那么系统在重新启动的时候，就会藉由Superblock当中记录的valid bit(是否有挂载)与filesystem state (clean与否)等状态来判断是否强制进行数据一致性的检查!若有需要检查时则以e2fsck这支程序来进行的。

## 异步处理

当系统加载一个档案到内存后，如果该档案没有被更动过，则在内存区段的档案数据会被设定为干净(clean)的。但如果内存中的档案数据被更改过了(例如你用nano去编辑过这个档案)，此时该内存中的数据会被设定为脏的(Dirty)。此时所有的动作都还在内存中执行，并没有写入到磁盘中!系统会不定时的将内存中设定为『Dirty』的数据写回磁盘，以保持磁盘与内存数据的一致性。

## 挂载

将文件系统与目录树结合的动作我们称为『挂载』。关于挂载的一些特性我们在第三章稍微提过，重点是∶挂载点一定是目录，该目录为进入该文件系统的入口。

## 文件系统操作

/proc的东西都是Linux系统所需要加载的系统数据，而且是挂载在『内存当中』的，不会占用磁盘空间

/dev/shm/是利用内存虚拟出来的磁盘空间

# ext2

![Window shadow](/assets/img/2022-08/2022-08-16-Linux%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84.drawio.svg){: .shadow}
_文件系统结构_

## 启动扇区(boot sector)

在整体的规划当中，文件系统最前面有一个启动扇区(boot sector)，这个启动扇区可以安装开机管理程序，这是个非常重要的设计，因为如此一来我们就能够将不同的开机管理程序安装到个别的文件系统最前端，而不用覆盖整颗硬盘唯一的 MBR，这样也才能够制作出多重引导的环境啊!

## 超级块(Super Block)

描述整个分区的文件系统信息。

超级块在每个块组的开头都有一份拷贝（第一个块组必须有，后面的块组可以没有）。

超级块记录的信息有：

1. block 与 inode 的总量（分区内所有Block Group的block和inode总量）；
2. 未使用与已使用的 inode / block 数量；
3. block 与 inode 的大小 (block 为 1, 2, 4K，inode 为 128 bytes)；
4. filesystem 的挂载时间、最近一次写入数据的时间、最近一次检验磁盘 (fsck) 的时间等文件系统的相关信息；
5. 一个 valid bit 数值，若此文件系统已被挂载，则 valid bit 为 0 ，若未被挂载，则 valid bit 为 1 。

## 块组描述符表(GDT,Group Descriptor Table)

由很多块组描述符组成，整个分区分成多个块组就对应有多少个块组描述符。

每个块组描述符存储一个块组的描述信息，如在这个块组中从哪里开始是inode Table，从哪里开始是 Data Blocks，空闲的inode和数据块还有多少个等等。

块组描述符在每个块组的开头都有一份拷贝。

## 块位图(Block Bitmap)

用来描述整个块组中哪些块已用哪些块空闲。

块位图本身占一个块，其中的每个bit代表本块组的一个block，这个bit为1代表该块已用，为0表示空闲可用。假设格式化时block大小为1KB，这样大小的一个块位图就可以表示1024*8个块的占用情况，因此一个块组最多可以有10248个块。

## inode位图(inode Bitmap)

和块位图类似，本身占一个块，其中每个bit表示一个inode是否空闲可用。 Inode bitmap的作用是记录block group中Inode区域的使用情况，Ext文件系统中一个block group中可以有16384个Inode，代表着这个Ext文件系统中一个block group最多可以描述16384个文件。

## inode表(inode Table)

由一个块组中的所有inode组成。一个文件除了数据需要存储之外，一些描述信息也需要存储，如文件类型，权限，文件大小，创建、修改、访问时间等，这些信息存在inode中而不是数据块中。

inode表占多少个块在格式化时就要写入块组描述符中。

data block可能和Inode同属于一个block group也可能分属于不同的block group。

12个直接、1个一级间接、1个二级间接、1个三级间接

## 数据块(Data Block)

是用来放置文件内容数据的地方。

1. 普通文件：数据存储在数据块中。
2. 目录：该目录下的所有文件名、目录名和inode号码存储在该目录inode关联的数据块中，
3. 符合链接：如果目标路径名较短则直接保存在inode中，如果较长则分配一个数据块来保存。

Block大小|1KB|2KB|4KB
--|--|--|--
最大单一文件限制|16GB|256GB|2TB
最大文件系统总容量|2TB|8TB|16TB

# VFS(Virtual Filesystem Switch)

整个Linux的系统都是透过一个名为Virtual Filesystem Switch 的核心功能去读取filesystem的。也就是说，整个 Linux认识的 filesystem 其实都是VFS在进行管理，我们使用者并不需要知道每个partition上头的 filesystem 是什么。

# 链接

- Hard Links： 为已存在的文件，新建一个指向该文件inode节点的目录项（directory entry），同时增加该inode的连接数。可以让一个文件有多个硬链接，出现在多个目录下。Hard link一般有两个限制：
  1. 不能跨文件系统（不同的文件系统有不同的inode table）；
  2. 不能连接目录（容易在文件系统中造成循环引用）。
- Symbolic Links：跟hard link不同，它是建立一个独立的文件，而这个文件的作用是当读取这个连接文件时，它会把读取的行为转发到该文件所link的文件上。这样讲，也许比较绕口，那么就来举一个例子。现在有文件a，我们做了一个软连接文件b（只是一个连接文件，非常小），b指向了文件a。当读取b时，那么b就会把读取的动作转发到a上，这样就读取到了文件a。所以，当你删除文件a时，文件b并不会被删除，但是再读取b时，会提示无法打开文件。而当你删除b时，a是不会有任何影响的。

# 缓冲区

缓冲区又称为缓存，它是内存空间的一部分。也就是说，在内存空间中预留了一定的存储空间，这些存储空间用来缓冲输入或输出的数据，这部分预留的空间就叫做缓冲区。缓冲区根据其对应的是输入设备还是输出设备，分为输入缓冲区和输出缓冲区。

- 一般缓冲区大小4096B

## 缓冲区类型

1. 全缓冲：当填满标准I/O缓存后才进行实际I/O操作。全缓冲的典型代表是对磁盘文件的读写。
2. 行缓冲：我们输入的字符先存放在缓冲区，当在输入和输出中遇到换行符时，执行真正的I/O操作。典型代表是键盘输入数据。
3. 不带缓冲：也就是不进行缓冲，标准出错情况stderr是典型代表。

标准输入|标准输出|标准错误
--|--|--
0|1|2

## 缓冲区刷新

刷新缓冲区，为执行I/O操作，并非清空缓冲区

1. 缓冲区满
2. 执行flush语句
3. 执行endl语句
4. 关闭文件

# 常用工具

dumpe2fs
: 每个区段与 superblock 的信息

e2fsck
: 数据一致性

sync
: 手动同步

df
: 列出文件系统的整体磁盘使用量

du
: 评估文件系统的磁盘使用量(常用在推估目录所占容量)

fdisk
: 磁盘分区

mkfs
: 文件系统格式化，mkfs命令本身并不执行建立文件系统的工作，而是去调用相关的程序来执行

mke2fs
: 在磁盘分区上创建ext2、ext3、ext4文件系统

fsck
: 文件系统检查

badblocks
: 硬盘坏轨检测

ln
: 软硬链接